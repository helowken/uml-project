<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4425px" preserveAspectRatio="none" style="width:1661px;height:4425px;" version="1.1" viewBox="0 0 1661 4425" width="1661px" zoomAndPan="magnify"><defs><filter height="300%" id="f1wwf1s7x4pqi6" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><path d="M684.5,10 L684.5,36.3516 A0,0 0 0 0 684.5,36.3516 L801.5,36.3516 A0,0 0 0 0 801.5,36.3516 L801.5,28 L821.5,23.1758 L801.5,20 L801.5,20 L791.5,10 L684.5,10 A0,0 0 0 0 684.5,10 " fill="#FBFB77" filter="url(#f1wwf1s7x4pqi6)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M791.5,10 L791.5,20 L801.5,20 L791.5,10 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="690.5" y="28.4951">LogManager init;</text><ellipse cx="831.5" cy="23.1758" fill="#000000" filter="url(#f1wwf1s7x4pqi6)" rx="10" ry="10" style="stroke: none; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="80.375" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="278" x="692.5" y="53.1758"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="143" x="702.5" y="75.6328">createAndValidateLogDirs</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="115" x="702.5" y="90.7266">1. filter not offlineDirs</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="115" x="702.5" y="105.8203">2. mkdirs if not exists</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="258" x="702.5" y="120.9141">3. add to liveLogDirs if is directory and can read</text><rect fill="#FF0000" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="267" x="698" y="202.4688"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="247" x="708" y="224.9258">Exit for no log dirs can be created or validated</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="782,153.5508,881,153.5508,893,165.5508,881,177.5508,782,177.5508,770,165.5508,782,153.5508" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="18" x="835.5" y="188.9697">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="99" x="782" y="170.0518">liveLogDirs isEmpty?</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="831.5,257.5625,843.5,269.5625,831.5,281.5625,819.5,269.5625,831.5,257.5625" style="stroke: #A80036; stroke-width: 1.5;"/><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="65.2813" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="282" x="690.5" y="301.5625"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="87" x="700.5" y="324.0195">lock liveLogDirs</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="262" x="700.5" y="339.1133">1. create .lock file with RW privileges if not exists</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="224" x="700.5" y="354.207">2. try to lock .lock file throught file channel</text><rect fill="#FFFFFF" filter="url(#f1wwf1s7x4pqi6)" height="3997.0127" style="stroke: #000000; stroke-width: 2.0;" width="1640" x="10" y="377.4199"/><path d="M78,378.4199 L78,388.0293 L68,398.0293 L10,398.0293 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="58" x="13" y="392.9531">loadLogs</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="528" x="567.5" y="458.4531"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="508" x="577.5" y="480.9102">set brokerState to RecoveringFromUncleanShutdown if ".kafka_cleanshutdown" file not exists</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="358" x="652.5" y="513.5469"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="338" x="662.5" y="536.0039">load recoveryPoints from "recovery-point-offset-checkpoint" file</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="328" x="667.5" y="568.6406"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="308" x="677.5" y="591.0977">load logStartOffsets from "log-start-offset-checkpoint" file</text><rect fill="#000000" filter="url(#f1wwf1s7x4pqi6)" height="6" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 1.0;" width="1575" x="44" y="623.7344"/><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="652" y="649.7344"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="146" x="662" y="672.1914">load topicPartition-0 log dir</text><rect fill="#FFFFFF" filter="url(#f1wwf1s7x4pqi6)" height="3619.0283" style="stroke: #000000; stroke-width: 2.0;" width="1351" x="58" y="695.4043"/><path d="M228,696.4043 L228,706.0137 L218,716.0137 L58,716.0137 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="61" y="710.9375">loadLogForTopicPartition</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="234" x="618" y="732.4375"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="214" x="628" y="754.8945">parse topicPartition from logDir's name</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="204" x="633" y="787.5313"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="184" x="643" y="809.9883">get recoveryPoint for topicPartition</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="205" x="632.5" y="842.625"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="185" x="642.5" y="865.082">get logStartOffset for topicPartition</text><rect fill="#FFFFFF" filter="url(#f1wwf1s7x4pqi6)" height="3147.0322" style="stroke: #000000; stroke-width: 2.0;" width="1331" x="68" y="888.2949"/><path d="M127,889.2949 L127,898.9043 L117,908.9043 L68,908.9043 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="71" y="903.8281">newLog</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="182" x="644" y="925.3281"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="162" x="654" y="947.7852">init leaderEpochCache for log</text><rect fill="#FFFFFF" filter="url(#f1wwf1s7x4pqi6)" height="2761.7666" style="stroke: #000000; stroke-width: 2.0;" width="1311" x="78" y="970.998"/><path d="M178,971.998 L178,981.6074 L168,991.6074 L78,991.6074 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="81" y="986.5313">loadSegments</text><rect fill="#FFFFFF" filter="url(#f1wwf1s7x4pqi6)" height="587.1641" style="stroke: #000000; stroke-width: 2.0;" width="897" x="285" y="998.6074"/><path d="M540,999.6074 L540,1009.2168 L530,1019.2168 L285,1019.2168 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="245" x="288" y="1014.1406">removeTempFilesAndCollectSwapFiles</text><rect fill="#FF0000" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="131" x="669.5" y="1128.5586"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="108" x="682.5" y="1151.0156">Error for reading file</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="692,1079.6406,778,1079.6406,790,1091.6406,778,1103.6406,692,1103.6406,680,1091.6406,692,1079.6406" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="18" x="739" y="1115.0596">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="86" x="692" y="1096.1416">file can't be read?</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="735,1183.6523,747,1195.6523,735,1207.6523,723,1195.6523,735,1183.6523" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="331,1227.6523,545,1227.6523,557,1239.6523,545,1251.6523,331,1251.6523,319,1239.6523,331,1227.6523" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="1263.0713">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="214" x="331" y="1244.1533">file name ends with ".deleted" or ".cleaned"?</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="73" x="401.5" y="1284.5713"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="53" x="411.5" y="1307.0283">delete file</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="768,1227.6523,910,1227.6523,922,1239.6523,910,1251.6523,768,1251.6523,756,1239.6523,768,1227.6523" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="18" x="843" y="1263.0713">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="142" x="768" y="1244.1533">file name ends with ".swap"?</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="589,1309.5713,694,1309.5713,706,1321.5713,694,1333.5713,589,1333.5713,577,1321.5713,589,1309.5713" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="18" x="645.5" y="1344.9902">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="105" x="589" y="1326.0723">it's a index swap file?</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="610" y="1366.4902"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="43" x="620" y="1388.9473">delete it</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="842,1309.5713,935,1309.5713,947,1321.5713,935,1333.5713,842,1333.5713,830,1321.5713,842,1309.5713" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="18" x="892.5" y="1344.9902">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="93" x="842" y="1326.0723">it's a log swap file?</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="137" x="820" y="1366.4902"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="117" x="830" y="1388.9473">collect it to swapFiles</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="325" x="726" y="1421.584"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="305" x="736" y="1444.041">delete index, timeindex and transactionIndex files if exist</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="668.5,1035.6406,801.5,1035.6406,813.5,1047.6406,801.5,1059.6406,668.5,1059.6406,656.5,1047.6406,668.5,1035.6406" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="133" x="668.5" y="1052.1416">has more file and file isFile?</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="112" x="679" y="1538.6777"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="92" x="689" y="1561.1348">return swapFiles</text><rect fill="#FFFFFF" filter="url(#f1wwf1s7x4pqi6)" height="1004.4121" style="stroke: #000000; stroke-width: 2.0;" width="1291" x="88" y="1596.3477"/><path d="M211,1597.3477 L211,1606.957 L201,1616.957 L88,1616.957 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="91" y="1611.8809">loadSegmentFiles</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="226.5,1677.3809,286.5,1677.3809,298.5,1689.3809,286.5,1701.3809,226.5,1701.3809,214.5,1689.3809,226.5,1677.3809" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="18" x="260.5" y="1712.7998">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="60" x="226.5" y="1693.8818">is index file?</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="269" x="122" y="1735.2168"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="249" x="132" y="1757.6738">delete it if the corresponding log file not exists</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="564.5,1677.3809,612.5,1677.3809,624.5,1689.3809,612.5,1701.3809,564.5,1701.3809,552.5,1689.3809,564.5,1677.3809" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="18" x="592.5" y="1712.7998">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="48" x="564.5" y="1693.8818">is log file?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="12" x="624.5" y="1686.9639">no</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="355" x="411" y="1735.2168"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="335" x="421" y="1757.6738">do sanity check for index, timeindex and transactionIndex files</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="237" x="470" y="1795.084"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="217" x="480" y="1817.541">recoverSegment if any sanity checks fail</text><rect fill="#FFFFFF" filter="url(#f1wwf1s7x4pqi6)" height="844.3789" style="stroke: #000000; stroke-width: 2.0;" width="562" x="786" y="1702.3809"/><path d="M900,1703.3809 L900,1712.9902 L890,1722.9902 L786,1722.9902 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="789" y="1717.9141">recoverSegment</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="490" x="823.5" y="1739.9902"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="470" x="833.5" y="1762.4473">truncate and reload producer states between logStartOffset and segment's baseOffset</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="520" x="808.5" y="1799.8574"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="500" x="818.5" y="1822.3145">find segments from lastSnapshotOffset and segment's baseOffset, load producers from log</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="283" x="927" y="1854.9512"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="263" x="937" y="1877.4082">take a snapshot to avoid reloading all segments</text><rect fill="#FFFFFF" filter="url(#f1wwf1s7x4pqi6)" height="516.1582" style="stroke: #000000; stroke-width: 2.0;" width="542" x="796" y="1900.6211"/><path d="M854,1901.6211 L854,1911.2305 L844,1921.2305 L796,1921.2305 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="799" y="1916.1543">recover</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="282" x="927.5" y="1937.6543"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="262" x="937.5" y="1960.1113">reset index, timeindex and transactionIndex files</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="95" x="1021" y="2036.748"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="75" x="1031" y="2059.2051">validate batch</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="331" x="903" y="2091.8418"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="311" x="913" y="2114.2988">calculate the maxTimestamp and offsetOfMaxTimestamp</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="65.2813" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="477" x="830" y="2146.9355"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="379" x="840" y="2169.3926">append index(batch's baseOffset, currentTotalValidBytes) to index file,</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="457" x="840" y="2184.4863">and append timeindex(maxTimestamp and offsetOfMaxTimestamp) to timeindex file</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="206" x="840" y="2199.5801">if accumulated valid bytes are enough</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="449" x="844" y="2232.2168"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="429" x="854" y="2254.6738">update latest leaderEpoch if batch's partitionLeaderEpoch &gt; cache's lastEpoch</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="95.4688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="440" x="848.5" y="2287.3105"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="120" x="858.5" y="2309.7676">update producer state</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="350" x="858.5" y="2324.8613">1. append batch info to transaction queue if contains producer id</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="420" x="858.5" y="2339.9551">2. complete transaction if batch is a controlBatch and transaction is openning</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="363" x="858.5" y="2355.0488">3. append transaction index if the completed transaction is aborted</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="271" x="858.5" y="2370.1426">2. update ProducerStateManager's mapEndOffset</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="1005.5,1992.748,1131.5,1992.748,1143.5,2004.748,1131.5,2016.748,1005.5,2016.748,993.5,2004.748,1005.5,1992.748" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="126" x="1005.5" y="2009.249">has more recordBatches?</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="230" x="953.5" y="2444.5723"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="210" x="963.5" y="2467.0293">take a snapshot after recover segment</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="300" x="918.5" y="2499.666"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="280" x="928.5" y="2522.123">calculate truncated bytes(invalid bytes) after recover</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="674,1633.3809,796,1633.3809,808,1645.3809,796,1657.3809,674,1657.3809,662,1645.3809,674,1633.3809" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="122" x="674" y="1649.8818">has more files and isFile?</text><rect fill="#FFFFFF" filter="url(#f1wwf1s7x4pqi6)" height="330.4082" style="stroke: #000000; stroke-width: 2.0;" width="524" x="471.5" y="2611.3359"/><path d="M642.5,2612.3359 L642.5,2621.9453 L632.5,2631.9453 L471.5,2631.9453 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="161" x="474.5" y="2626.8691">completeSwapOperations</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="459" x="505.5" y="2692.3691"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="439" x="515.5" y="2714.8262">new a swapLogSegment from swap files(log, index, timeindex, transactionIndex)</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="187" x="641.5" y="2747.4629"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="167" x="651.5" y="2769.9199">recover this swapLogSegment</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="424" x="523" y="2817.5566"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="404" x="533" y="2840.0137">find oldSegments between swapLogSegment's baseOffset and nextOffset</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="429" x="520.5" y="2872.6504"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="409" x="530.5" y="2895.1074">replace oldSegments by the swapSegment and delete them asynchronous</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="683,2648.3691,787,2648.3691,799,2660.3691,787,2672.3691,683,2672.3691,671,2660.3691,683,2648.3691" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="104" x="683" y="2664.8701">has more swapFiles?</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="427.5,2961.7441,520.5,2961.7441,532.5,2973.7441,520.5,2985.7441,427.5,2985.7441,415.5,2973.7441,427.5,2961.7441" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="18" x="478" y="2997.1631">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="93" x="427.5" y="2978.2451">segments isEmpty?</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="197" x="375.5" y="3018.6631"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="177" x="385.5" y="3041.1201">add a segment with 0 startOffset</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="136" x="406" y="3088.7568"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="116" x="416" y="3111.2139">return 0 as nextOffset</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="661,2961.7441,858,2961.7441,870,2973.7441,858,2985.7441,661,2985.7441,649,2973.7441,661,2961.7441" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="18" x="763.5" y="2997.1631">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="197" x="661" y="2978.2451">logDir's name doesn't end with "-delete"?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="12" x="870" y="2971.3271">no</text><rect fill="#FFFFFF" filter="url(#f1wwf1s7x4pqi6)" height="571.9141" style="stroke: #000000; stroke-width: 2.0;" width="346" x="592.5" y="3018.6631"/><path d="M674.5,3019.6631 L674.5,3029.2725 L664.5,3039.2725 L592.5,3039.2725 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="595.5" y="3034.1963">recoverLog</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="294" x="612.5" y="3105.1904"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="274" x="622.5" y="3127.6475">find unflushedSegments beyond the recoveryPoint</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="110" x="704.5" y="3204.2842"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="90" x="714.5" y="3226.7412">recoverSegment</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="213" x="653" y="3308.2959"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="193" x="663" y="3330.7529">delete the rest unflushedSegments</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="78" x="720.5" y="3378.3896"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="58" x="730.5" y="3400.8467">break loop</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="674.5,3259.3779,844.5,3259.3779,856.5,3271.3779,844.5,3283.3779,674.5,3283.3779,662.5,3271.3779,674.5,3259.3779" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="18" x="763.5" y="3294.7969">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="170" x="674.5" y="3275.8789">after recovery, truncted bytes &gt; 0?</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="759.5,3433.4834,771.5,3445.4834,759.5,3457.4834,747.5,3445.4834,759.5,3433.4834" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="684.5,3160.2842,834.5,3160.2842,846.5,3172.2842,834.5,3184.2842,684.5,3184.2842,672.5,3172.2842,684.5,3160.2842" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="150" x="684.5" y="3176.7852">has more unflushedSegments?</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="673,3056.2725,846,3056.2725,858,3068.2725,846,3080.2725,673,3080.2725,661,3068.2725,673,3056.2725" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="12" x="763.5" y="3091.6914">no</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="173" x="673" y="3072.7734">".kafka_cleanshutdown" file exists?</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="759.5,3499.4834,771.5,3511.4834,759.5,3523.4834,747.5,3511.4834,759.5,3499.4834" style="stroke: #A80036; stroke-width: 1.5;"/><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="271" x="624" y="3543.4834"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="251" x="634" y="3565.9404">get last segment's nextOffset as recoveryPoint</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="288" x="615.5" y="3610.5771"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="268" x="625.5" y="3633.0342">resize the last segment's index and timeindex file</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="201" x="659" y="3665.6709"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="181" x="669" y="3688.1279">return nextOffset from recoverLog</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="136" x="958.5" y="3353.667"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="116" x="968.5" y="3376.124">return 0 as nextOffset</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="394" x="538" y="3752.7646"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="374" x="548" y="3775.2217">get nextOffset after loadSegments and create nextLogOffsetMetadata</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="328" x="571" y="3807.8584"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="308" x="581" y="3830.3154">clean and flush latest leaderEpochCache with nextOffset</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="50.1875" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="275" x="597.5" y="3862.9521"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="175" x="607.5" y="3885.4092">calculate the new logStartOffset:</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="255" x="607.5" y="3900.5029">max(logStartOffset, first segment's baseOffset)</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="359" x="555.5" y="3933.1396"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="339" x="565.5" y="3955.5967">clean and flush earliest leaderEpochCache with logStartOffset</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="260" x="605" y="3988.2334"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="240" x="615" y="4010.6904">load producer state from logEndOffset(todo)</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="652.5,4055.3271,817.5,4055.3271,829.5,4067.3271,817.5,4079.3271,652.5,4079.3271,640.5,4067.3271,652.5,4055.3271" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="165" x="652.5" y="4071.8281">logDir's name ends with "-delete"?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="18" x="622.5" y="4064.9102">yes</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="247" x="480" y="4089.3271"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="227" x="490" y="4111.7842">add to a queue for deleting in background</text><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="205" x="764" y="4089.3271"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="185" x="774" y="4111.7842">put log to LogManager's logs pool</text><rect fill="#FF0000" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="198" x="767.5" y="4193.3389"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="178" x="777.5" y="4215.7959">Error for duplicate log directories</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="759,4144.4209,974,4144.4209,986,4156.4209,974,4168.4209,759,4168.4209,747,4156.4209,759,4144.4209" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="18" x="870.5" y="4179.8398">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="215" x="759" y="4160.9219">there's a previous log for the same partition?</text><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="866.5,4248.4326,878.5,4260.4326,866.5,4272.4326,854.5,4260.4326,866.5,4248.4326" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="735,4278.4326,747,4290.4326,735,4302.4326,723,4290.4326,735,4278.4326" style="stroke: #A80036; stroke-width: 1.5;"/><rect fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" height="35.0938" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="168" x="1437" y="2436.7793"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="148" x="1447" y="2459.2363">load topicPartition-N log dir</text><rect fill="#000000" filter="url(#f1wwf1s7x4pqi6)" height="6" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 1.0;" width="1575" x="44" y="4334.4326"/><polygon fill="#FEFECE" filter="url(#f1wwf1s7x4pqi6)" points="788,414.4531,875,414.4531,887,426.4531,875,438.4531,788,438.4531,776,426.4531,788,414.4531" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="87" x="788" y="430.9541">has more logDirs?</text><ellipse cx="831.5" cy="4404.4326" fill="none" filter="url(#f1wwf1s7x4pqi6)" rx="10" ry="10" style="stroke: #000000; stroke-width: 1.0;"/><ellipse cx="832" cy="4404.9326" fill="#000000" filter="url(#f1wwf1s7x4pqi6)" rx="6" ry="6" style="stroke: none; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="831.5" x2="831.5" y1="33.1758" y2="53.1758"/><polygon fill="#A80036" points="827.5,43.1758,831.5,53.1758,835.5,43.1758,831.5,47.1758" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="831.5" x2="831.5" y1="177.5508" y2="202.4688"/><polygon fill="#A80036" points="827.5,192.4688,831.5,202.4688,835.5,192.4688,831.5,196.4688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="893" x2="975" y1="165.5508" y2="165.5508"/><polygon fill="#A80036" points="971,210.0156,975,220.0156,979,210.0156,975,214.0156" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="975" x2="975" y1="165.5508" y2="269.5625"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="975" x2="843.5" y1="269.5625" y2="269.5625"/><polygon fill="#A80036" points="853.5,265.5625,843.5,269.5625,853.5,273.5625,849.5,269.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="831.5" x2="831.5" y1="237.5625" y2="257.5625"/><polygon fill="#A80036" points="827.5,247.5625,831.5,257.5625,835.5,247.5625,831.5,251.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="831.5" x2="831.5" y1="133.5508" y2="153.5508"/><polygon fill="#A80036" points="827.5,143.5508,831.5,153.5508,835.5,143.5508,831.5,147.5508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="831.5" x2="831.5" y1="281.5625" y2="301.5625"/><polygon fill="#A80036" points="827.5,291.5625,831.5,301.5625,835.5,291.5625,831.5,295.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="831.5" x2="831.5" y1="493.5469" y2="513.5469"/><polygon fill="#A80036" points="827.5,503.5469,831.5,513.5469,835.5,503.5469,831.5,507.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="831.5" x2="831.5" y1="548.6406" y2="568.6406"/><polygon fill="#A80036" points="827.5,558.6406,831.5,568.6406,835.5,558.6406,831.5,562.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="767.5313" y2="787.5313"/><polygon fill="#A80036" points="731,777.5313,735,787.5313,739,777.5313,735,781.5313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="822.625" y2="842.625"/><polygon fill="#A80036" points="731,832.625,735,842.625,739,832.625,735,836.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="1103.6406" y2="1128.5586"/><polygon fill="#A80036" points="731,1118.5586,735,1128.5586,739,1118.5586,735,1122.5586" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="790" x2="810.5" y1="1091.6406" y2="1091.6406"/><polygon fill="#A80036" points="806.5,1136.1055,810.5,1146.1055,814.5,1136.1055,810.5,1140.1055" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="810.5" x2="810.5" y1="1091.6406" y2="1195.6523"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="810.5" x2="747" y1="1195.6523" y2="1195.6523"/><polygon fill="#A80036" points="757,1191.6523,747,1195.6523,757,1199.6523,753,1195.6523" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="1163.6523" y2="1183.6523"/><polygon fill="#A80036" points="731,1173.6523,735,1183.6523,739,1173.6523,735,1177.6523" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="888.5" x2="888.5" y1="1401.584" y2="1421.584"/><polygon fill="#A80036" points="884.5,1411.584,888.5,1421.584,892.5,1411.584,888.5,1415.584" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="641.5" x2="641.5" y1="1333.5713" y2="1366.4902"/><polygon fill="#A80036" points="637.5,1356.4902,641.5,1366.4902,645.5,1356.4902,641.5,1360.4902" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="641.5" x2="641.5" y1="1401.584" y2="1476.6777"/><polygon fill="#A80036" points="637.5,1466.6777,641.5,1476.6777,645.5,1466.6777,641.5,1470.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="888.5" x2="888.5" y1="1333.5713" y2="1366.4902"/><polygon fill="#A80036" points="884.5,1356.4902,888.5,1366.4902,892.5,1356.4902,888.5,1360.4902" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="888.5" x2="888.5" y1="1456.6777" y2="1476.6777"/><polygon fill="#A80036" points="884.5,1466.6777,888.5,1476.6777,892.5,1466.6777,888.5,1470.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="706" x2="830" y1="1321.5713" y2="1321.5713"/><polygon fill="#A80036" points="820,1317.5713,830,1321.5713,820,1325.5713,824,1321.5713" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="839" x2="839" y1="1251.6523" y2="1284.5713"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="839" x2="641.5" y1="1284.5713" y2="1284.5713"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="641.5" x2="641.5" y1="1284.5713" y2="1309.5713"/><polygon fill="#A80036" points="637.5,1299.5713,641.5,1309.5713,645.5,1299.5713,641.5,1303.5713" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="947" x2="1086" y1="1321.5713" y2="1321.5713"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1086" x2="1086" y1="1321.5713" y2="1476.6777"/><polygon fill="#A80036" points="1082,1466.6777,1086,1476.6777,1090,1466.6777,1086,1470.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="641.5" x2="1086" y1="1476.6777" y2="1476.6777"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="438" x2="438" y1="1251.6523" y2="1284.5713"/><polygon fill="#A80036" points="434,1274.5713,438,1284.5713,442,1274.5713,438,1278.5713" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="438" x2="438" y1="1319.665" y2="1496.6777"/><polygon fill="#A80036" points="434,1486.6777,438,1496.6777,442,1486.6777,438,1490.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="839" x2="839" y1="1476.6777" y2="1496.6777"/><polygon fill="#A80036" points="835,1486.6777,839,1496.6777,843,1486.6777,839,1490.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="557" x2="756" y1="1239.6523" y2="1239.6523"/><polygon fill="#A80036" points="746,1235.6523,756,1239.6523,746,1243.6523,750,1239.6523" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="1207.6523" y2="1212.6523"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="438" y1="1212.6523" y2="1212.6523"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="438" x2="438" y1="1212.6523" y2="1227.6523"/><polygon fill="#A80036" points="434,1217.6523,438,1227.6523,442,1217.6523,438,1221.6523" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="922" x2="1136" y1="1239.6523" y2="1239.6523"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1136" x2="1136" y1="1239.6523" y2="1496.6777"/><polygon fill="#A80036" points="1132,1486.6777,1136,1496.6777,1140,1486.6777,1136,1490.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="438" x2="1136" y1="1496.6777" y2="1496.6777"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="1059.6406" y2="1079.6406"/><polygon fill="#A80036" points="731,1069.6406,735,1079.6406,739,1069.6406,735,1073.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="1496.6777" y2="1506.6777"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="1163" y1="1506.6777" y2="1506.6777"/><polygon fill="#A80036" points="1159,1326.2002,1163,1316.2002,1167,1326.2002,1163,1322.2002" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1163" x2="1163" y1="1047.6406" y2="1506.6777"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1163" x2="813.5" y1="1047.6406" y2="1047.6406"/><polygon fill="#A80036" points="823.5,1043.6406,813.5,1047.6406,823.5,1051.6406,819.5,1047.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="656.5" x2="307" y1="1047.6406" y2="1047.6406"/><polygon fill="#A80036" points="303,1312.2002,307,1322.2002,311,1312.2002,307,1316.2002" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="307" x2="307" y1="1047.6406" y2="1518.6777"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="307" x2="735" y1="1518.6777" y2="1518.6777"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="1518.6777" y2="1538.6777"/><polygon fill="#A80036" points="731,1528.6777,735,1538.6777,739,1528.6777,735,1532.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="588.5" x2="588.5" y1="1770.3105" y2="1795.084"/><polygon fill="#A80036" points="584.5,1785.084,588.5,1795.084,592.5,1785.084,588.5,1789.084" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1068.5" y1="1775.084" y2="1799.8574"/><polygon fill="#A80036" points="1064.5,1789.8574,1068.5,1799.8574,1072.5,1789.8574,1068.5,1793.8574" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1068.5" y1="1834.9512" y2="1854.9512"/><polygon fill="#A80036" points="1064.5,1844.9512,1068.5,1854.9512,1072.5,1844.9512,1068.5,1848.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1068.5" y1="2071.8418" y2="2091.8418"/><polygon fill="#A80036" points="1064.5,2081.8418,1068.5,2091.8418,1072.5,2081.8418,1068.5,2085.8418" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1068.5" y1="2126.9355" y2="2146.9355"/><polygon fill="#A80036" points="1064.5,2136.9355,1068.5,2146.9355,1072.5,2136.9355,1068.5,2140.9355" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1068.5" y1="2212.2168" y2="2232.2168"/><polygon fill="#A80036" points="1064.5,2222.2168,1068.5,2232.2168,1072.5,2222.2168,1068.5,2226.2168" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1068.5" y1="2267.3105" y2="2287.3105"/><polygon fill="#A80036" points="1064.5,2277.3105,1068.5,2287.3105,1072.5,2277.3105,1068.5,2281.3105" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1068.5" y1="2016.748" y2="2036.748"/><polygon fill="#A80036" points="1064.5,2026.748,1068.5,2036.748,1072.5,2026.748,1068.5,2030.748" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1068.5" y1="2382.7793" y2="2392.7793"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1319" y1="2392.7793" y2="2392.7793"/><polygon fill="#A80036" points="1315,2207.7637,1319,2197.7637,1323,2207.7637,1319,2203.7637" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1319" x2="1319" y1="2004.748" y2="2392.7793"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1319" x2="1143.5" y1="2004.748" y2="2004.748"/><polygon fill="#A80036" points="1153.5,2000.748,1143.5,2004.748,1153.5,2008.748,1149.5,2004.748" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="993.5" x2="818" y1="2004.748" y2="2004.748"/><polygon fill="#A80036" points="814,2193.7637,818,2203.7637,822,2193.7637,818,2197.7637" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="818" x2="818" y1="2004.748" y2="2404.7793"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="818" x2="1068.5" y1="2404.7793" y2="2404.7793"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1068.5" y1="2404.7793" y2="2444.5723"/><polygon fill="#A80036" points="1064.5,2434.5723,1068.5,2444.5723,1072.5,2434.5723,1068.5,2438.5723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1068.5" y1="1972.748" y2="1992.748"/><polygon fill="#A80036" points="1064.5,1982.748,1068.5,1992.748,1072.5,1982.748,1068.5,1986.748" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1068.5" y1="1890.0449" y2="1937.6543"/><polygon fill="#A80036" points="1064.5,1927.6543,1068.5,1937.6543,1072.5,1927.6543,1068.5,1931.6543" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1068.5" y1="2479.666" y2="2499.666"/><polygon fill="#A80036" points="1064.5,2489.666,1068.5,2499.666,1072.5,2489.666,1068.5,2493.666" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="256.5" x2="256.5" y1="1701.3809" y2="1735.2168"/><polygon fill="#A80036" points="252.5,1725.2168,256.5,1735.2168,260.5,1725.2168,256.5,1729.2168" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="256.5" x2="256.5" y1="1770.3105" y2="2566.7598"/><polygon fill="#A80036" points="252.5,2556.7598,256.5,2566.7598,260.5,2556.7598,256.5,2560.7598" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="588.5" x2="588.5" y1="1701.3809" y2="1735.2168"/><polygon fill="#A80036" points="584.5,1725.2168,588.5,1735.2168,592.5,1725.2168,588.5,1729.2168" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="588.5" x2="588.5" y1="1830.1777" y2="2566.7598"/><polygon fill="#A80036" points="584.5,2556.7598,588.5,2566.7598,592.5,2556.7598,588.5,2560.7598" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="298.5" x2="552.5" y1="1689.3809" y2="1689.3809"/><polygon fill="#A80036" points="542.5,1685.3809,552.5,1689.3809,542.5,1693.3809,546.5,1689.3809" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="1657.3809" y2="1662.3809"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="256.5" y1="1662.3809" y2="1662.3809"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="256.5" x2="256.5" y1="1662.3809" y2="1677.3809"/><polygon fill="#A80036" points="252.5,1667.3809,256.5,1677.3809,260.5,1667.3809,256.5,1671.3809" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="624.5" x2="1068.5" y1="1689.3809" y2="1689.3809"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1068.5" y1="1689.3809" y2="1739.9902"/><polygon fill="#A80036" points="1064.5,1729.9902,1068.5,1739.9902,1072.5,1729.9902,1068.5,1733.9902" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.5" x2="1068.5" y1="2534.7598" y2="2566.7598"/><polygon fill="#A80036" points="1064.5,2556.7598,1068.5,2566.7598,1072.5,2556.7598,1068.5,2560.7598" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="256.5" x2="1068.5" y1="2566.7598" y2="2566.7598"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="2566.7598" y2="2576.7598"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="1360" y1="2576.7598" y2="2576.7598"/><polygon fill="#A80036" points="1356,2123.0605,1360,2113.0605,1364,2123.0605,1360,2119.0605" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1360" x2="1360" y1="1645.3809" y2="2576.7598"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1360" x2="808" y1="1645.3809" y2="1645.3809"/><polygon fill="#A80036" points="818,1641.3809,808,1645.3809,818,1649.3809,814,1645.3809" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="662" x2="110" y1="1645.3809" y2="1645.3809"/><polygon fill="#A80036" points="106,2109.0605,110,2119.0605,114,2109.0605,110,2113.0605" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="110" x2="110" y1="1645.3809" y2="2588.7598"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="110" x2="735" y1="2588.7598" y2="2588.7598"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="2588.7598" y2="2648.3691"/><polygon fill="#A80036" points="731,2638.3691,735,2648.3691,739,2638.3691,735,2642.3691" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="1573.7715" y2="1633.3809"/><polygon fill="#A80036" points="731,1623.3809,735,1633.3809,739,1623.3809,735,1627.3809" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="2727.4629" y2="2747.4629"/><polygon fill="#A80036" points="731,2737.4629,735,2747.4629,739,2737.4629,735,2741.4629" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="2782.5566" y2="2817.5566"/><polygon fill="#A80036" points="731,2807.5566,735,2817.5566,739,2807.5566,735,2811.5566" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="2852.6504" y2="2872.6504"/><polygon fill="#A80036" points="731,2862.6504,735,2872.6504,739,2862.6504,735,2866.6504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="2672.3691" y2="2692.3691"/><polygon fill="#A80036" points="731,2682.3691,735,2692.3691,739,2682.3691,735,2686.3691" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="2907.7441" y2="2917.7441"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="976.5" y1="2917.7441" y2="2917.7441"/><polygon fill="#A80036" points="972.5,2798.0566,976.5,2788.0566,980.5,2798.0566,976.5,2794.0566" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="976.5" x2="976.5" y1="2660.3691" y2="2917.7441"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="976.5" x2="799" y1="2660.3691" y2="2660.3691"/><polygon fill="#A80036" points="809,2656.3691,799,2660.3691,809,2664.3691,805,2660.3691" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="671" x2="493.5" y1="2660.3691" y2="2660.3691"/><polygon fill="#A80036" points="489.5,2784.0566,493.5,2794.0566,497.5,2784.0566,493.5,2788.0566" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="493.5" x2="493.5" y1="2660.3691" y2="2929.7441"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="493.5" x2="735" y1="2929.7441" y2="2929.7441"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="2929.7441" y2="2946.7441"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="474" x2="474" y1="3053.7568" y2="3088.7568"/><polygon fill="#A80036" points="470,3078.7568,474,3088.7568,478,3078.7568,474,3082.7568" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="759.5" y1="3343.3896" y2="3378.3896"/><polygon fill="#A80036" points="755.5,3368.3896,759.5,3378.3896,763.5,3368.3896,759.5,3372.3896" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="759.5" y1="3283.3779" y2="3308.2959"/><polygon fill="#A80036" points="755.5,3298.2959,759.5,3308.2959,763.5,3298.2959,759.5,3302.2959" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="856.5" x2="876" y1="3271.3779" y2="3271.3779"/><polygon fill="#A80036" points="872,3350.8896,876,3360.8896,880,3350.8896,876,3354.8896" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="876" x2="876" y1="3271.3779" y2="3445.4834"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="876" x2="771.5" y1="3445.4834" y2="3445.4834"/><polygon fill="#A80036" points="781.5,3441.4834,771.5,3445.4834,781.5,3449.4834,777.5,3445.4834" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="759.5" y1="3413.4834" y2="3433.4834"/><polygon fill="#A80036" points="755.5,3423.4834,759.5,3433.4834,763.5,3423.4834,759.5,3427.4834" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="759.5" y1="3239.3779" y2="3259.3779"/><polygon fill="#A80036" points="755.5,3249.3779,759.5,3259.3779,763.5,3249.3779,759.5,3253.3779" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="759.5" y1="3184.2842" y2="3204.2842"/><polygon fill="#A80036" points="755.5,3194.2842,759.5,3204.2842,763.5,3194.2842,759.5,3198.2842" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="759.5" y1="3457.4834" y2="3467.4834"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="900" y1="3467.4834" y2="3467.4834"/><polygon fill="#A80036" points="896,3323.8428,900,3313.8428,904,3323.8428,900,3319.8428" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="900" x2="900" y1="3172.2842" y2="3467.4834"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="900" x2="846.5" y1="3172.2842" y2="3172.2842"/><polygon fill="#A80036" points="856.5,3168.2842,846.5,3172.2842,856.5,3176.2842,852.5,3172.2842" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="672.5" x2="631" y1="3172.2842" y2="3172.2842"/><polygon fill="#A80036" points="627,3309.8428,631,3319.8428,635,3309.8428,631,3313.8428" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="631" x2="631" y1="3172.2842" y2="3479.4834"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="631" x2="759.5" y1="3479.4834" y2="3479.4834"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="759.5" y1="3479.4834" y2="3499.4834"/><polygon fill="#A80036" points="755.5,3489.4834,759.5,3499.4834,763.5,3489.4834,759.5,3493.4834" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="759.5" y1="3140.2842" y2="3160.2842"/><polygon fill="#A80036" points="755.5,3150.2842,759.5,3160.2842,763.5,3150.2842,759.5,3154.2842" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="759.5" y1="3080.2725" y2="3105.1904"/><polygon fill="#A80036" points="755.5,3095.1904,759.5,3105.1904,763.5,3095.1904,759.5,3099.1904" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="858" x2="916.5" y1="3068.2725" y2="3068.2725"/><polygon fill="#A80036" points="912.5,3268.7959,916.5,3278.7959,920.5,3268.7959,916.5,3272.7959" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="916.5" x2="916.5" y1="3068.2725" y2="3511.4834"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="916.5" x2="771.5" y1="3511.4834" y2="3511.4834"/><polygon fill="#A80036" points="781.5,3507.4834,771.5,3511.4834,781.5,3515.4834,777.5,3511.4834" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="759.5" y1="3523.4834" y2="3543.4834"/><polygon fill="#A80036" points="755.5,3533.4834,759.5,3543.4834,763.5,3533.4834,759.5,3537.4834" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="759.5" y1="3578.5771" y2="3610.5771"/><polygon fill="#A80036" points="755.5,3600.5771,759.5,3610.5771,763.5,3600.5771,759.5,3604.5771" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="759.5" y1="3645.6709" y2="3665.6709"/><polygon fill="#A80036" points="755.5,3655.6709,759.5,3665.6709,763.5,3655.6709,759.5,3659.6709" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="474" x2="474" y1="2985.7441" y2="3018.6631"/><polygon fill="#A80036" points="470,3008.6631,474,3018.6631,478,3008.6631,474,3012.6631" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="474" x2="474" y1="3123.8506" y2="3720.7646"/><polygon fill="#A80036" points="470,3710.7646,474,3720.7646,478,3710.7646,474,3714.7646" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="759.5" y1="2985.7441" y2="3056.2725"/><polygon fill="#A80036" points="755.5,3046.2725,759.5,3056.2725,763.5,3046.2725,759.5,3050.2725" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="759.5" x2="759.5" y1="3700.7646" y2="3720.7646"/><polygon fill="#A80036" points="755.5,3710.7646,759.5,3720.7646,763.5,3710.7646,759.5,3714.7646" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="532.5" x2="649" y1="2973.7441" y2="2973.7441"/><polygon fill="#A80036" points="639,2969.7441,649,2973.7441,639,2977.7441,643,2973.7441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="474" y1="2946.7441" y2="2946.7441"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="474" x2="474" y1="2946.7441" y2="2961.7441"/><polygon fill="#A80036" points="470,2951.7441,474,2961.7441,478,2951.7441,474,2955.7441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="870" x2="1026.5" y1="2973.7441" y2="2973.7441"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1026.5" x2="1026.5" y1="2973.7441" y2="3353.667"/><polygon fill="#A80036" points="1022.5,3343.667,1026.5,3353.667,1030.5,3343.667,1026.5,3347.667" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1026.5" x2="1026.5" y1="3388.7607" y2="3720.7646"/><polygon fill="#A80036" points="1022.5,3710.7646,1026.5,3720.7646,1030.5,3710.7646,1026.5,3714.7646" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="474" x2="1026.5" y1="3720.7646" y2="3720.7646"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="960.4219" y2="1035.6406"/><polygon fill="#A80036" points="731,1025.6406,735,1035.6406,739,1025.6406,735,1029.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="3720.7646" y2="3752.7646"/><polygon fill="#A80036" points="731,3742.7646,735,3752.7646,739,3742.7646,735,3746.7646" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="3787.8584" y2="3807.8584"/><polygon fill="#A80036" points="731,3797.8584,735,3807.8584,739,3797.8584,735,3801.8584" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="3842.9521" y2="3862.9521"/><polygon fill="#A80036" points="731,3852.9521,735,3862.9521,739,3852.9521,735,3856.9521" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="3913.1396" y2="3933.1396"/><polygon fill="#A80036" points="731,3923.1396,735,3933.1396,739,3923.1396,735,3927.1396" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="3968.2334" y2="3988.2334"/><polygon fill="#A80036" points="731,3978.2334,735,3988.2334,739,3978.2334,735,3982.2334" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="877.7188" y2="925.3281"/><polygon fill="#A80036" points="731,915.3281,735,925.3281,739,915.3281,735,919.3281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="866.5" x2="866.5" y1="4168.4209" y2="4193.3389"/><polygon fill="#A80036" points="862.5,4183.3389,866.5,4193.3389,870.5,4183.3389,866.5,4187.3389" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="986" x2="998" y1="4156.4209" y2="4156.4209"/><polygon fill="#A80036" points="994,4200.8857,998,4210.8857,1002,4200.8857,998,4204.8857" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="998" x2="998" y1="4156.4209" y2="4260.4326"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="998" x2="878.5" y1="4260.4326" y2="4260.4326"/><polygon fill="#A80036" points="888.5,4256.4326,878.5,4260.4326,888.5,4264.4326,884.5,4260.4326" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="866.5" x2="866.5" y1="4228.4326" y2="4248.4326"/><polygon fill="#A80036" points="862.5,4238.4326,866.5,4248.4326,870.5,4238.4326,866.5,4242.4326" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="866.5" x2="866.5" y1="4124.4209" y2="4144.4209"/><polygon fill="#A80036" points="862.5,4134.4209,866.5,4144.4209,870.5,4134.4209,866.5,4138.4209" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="640.5" x2="603.5" y1="4067.3271" y2="4067.3271"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="603.5" x2="603.5" y1="4067.3271" y2="4089.3271"/><polygon fill="#A80036" points="599.5,4079.3271,603.5,4089.3271,607.5,4079.3271,603.5,4083.3271" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="829.5" x2="866.5" y1="4067.3271" y2="4067.3271"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="866.5" x2="866.5" y1="4067.3271" y2="4089.3271"/><polygon fill="#A80036" points="862.5,4079.3271,866.5,4089.3271,870.5,4079.3271,866.5,4083.3271" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="603.5" x2="603.5" y1="4124.4209" y2="4290.4326"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="603.5" x2="723" y1="4290.4326" y2="4290.4326"/><polygon fill="#A80036" points="713,4286.4326,723,4290.4326,713,4294.4326,717,4290.4326" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="866.5" x2="866.5" y1="4272.4326" y2="4290.4326"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="866.5" x2="747" y1="4290.4326" y2="4290.4326"/><polygon fill="#A80036" points="757,4286.4326,747,4290.4326,757,4294.4326,753,4290.4326" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="4023.3271" y2="4055.3271"/><polygon fill="#A80036" points="731,4045.3271,735,4055.3271,739,4045.3271,735,4049.3271" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="684.8281" y2="732.4375"/><polygon fill="#A80036" points="731,722.4375,735,732.4375,739,722.4375,735,726.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="629.7344" y2="649.7344"/><polygon fill="#A80036" points="731,639.7344,735,649.7344,739,639.7344,735,643.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1521" x2="1521" y1="629.7344" y2="2436.7793"/><polygon fill="#A80036" points="1517,2426.7793,1521,2436.7793,1525,2426.7793,1521,2430.7793" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="735" x2="735" y1="4302.4326" y2="4334.4326"/><polygon fill="#A80036" points="731,4324.4326,735,4334.4326,739,4324.4326,735,4328.4326" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1521" x2="1521" y1="2471.873" y2="4334.4326"/><polygon fill="#A80036" points="1517,4324.4326,1521,4334.4326,1525,4324.4326,1521,4328.4326" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="831.5" x2="831.5" y1="603.7344" y2="623.7344"/><polygon fill="#A80036" points="827.5,613.7344,831.5,623.7344,835.5,613.7344,831.5,617.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="831.5" x2="831.5" y1="438.4531" y2="458.4531"/><polygon fill="#A80036" points="827.5,448.4531,831.5,458.4531,835.5,448.4531,831.5,452.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="831.5" x2="831.5" y1="4340.4326" y2="4350.4326"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="831.5" x2="1631" y1="4350.4326" y2="4350.4326"/><polygon fill="#A80036" points="1627,2364.3926,1631,2354.3926,1635,2364.3926,1631,2360.3926" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1631" x2="1631" y1="426.4531" y2="4350.4326"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1631" x2="887" y1="426.4531" y2="426.4531"/><polygon fill="#A80036" points="897,422.4531,887,426.4531,897,430.4531,893,426.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="776" x2="32" y1="426.4531" y2="426.4531"/><polygon fill="#A80036" points="28,2350.3926,32,2360.3926,36,2350.3926,32,2354.3926" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="32" x2="32" y1="426.4531" y2="4362.4326"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="32" x2="831.5" y1="4362.4326" y2="4362.4326"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="831.5" x2="831.5" y1="4362.4326" y2="4394.4326"/><polygon fill="#A80036" points="827.5,4384.4326,831.5,4394.4326,835.5,4384.4326,831.5,4388.4326" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="831.5" x2="831.5" y1="366.8438" y2="414.4531"/><polygon fill="#A80036" points="827.5,404.4531,831.5,414.4531,835.5,404.4531,831.5,408.4531" style="stroke: #A80036; stroke-width: 1.0;"/><!--
@startuml
start
note left: LogManager init;

:createAndValidateLogDirs
1. filter not offlineDirs
2. mkdirs if not exists
3. add to liveLogDirs if is directory and can read;

if (liveLogDirs isEmpty?) then(yes)
	#Red:Exit for no log dirs can be created or validated;
endif

:lock liveLogDirs
1. create .lock file with RW privileges if not exists
2. try to lock .lock file throught file channel;

partition loadLogs {
	while (has more logDirs?)
		:set brokerState to RecoveringFromUncleanShutdown if ".kafka_cleanshutdown" file not exists;
		
		:load recoveryPoints from "recovery-point-offset-checkpoint" file;
		:load logStartOffsets from "log-start-offset-checkpoint" file;

		fork
			:load topicPartition-0 log dir;
			partition loadLogForTopicPartition {
				:parse topicPartition from logDir's name;
				:get recoveryPoint for topicPartition;
				:get logStartOffset for topicPartition;

				partition newLog {
					:init leaderEpochCache for log;
					
					partition loadSegments {
						partition removeTempFilesAndCollectSwapFiles {
							while (has more file and file isFile?)
								if (file can't be read?) then(yes)
									#Red: Error for reading file;
								endif
								if (file name ends with ".deleted" or ".cleaned"?) then(yes)
									:delete file;
								elseif (file name ends with ".swap"?) then(yes)
									if (it's a index swap file?) then(yes)
										:delete it;
									elseif (it's a log swap file?) then(yes)
										:collect it to swapFiles;
										:delete index, timeindex and transactionIndex files if exist;
									endif
								endif
							end while
							:return swapFiles;
						}

						partition loadSegmentFiles {
							while (has more files and isFile?)
								if (is index file?) then(yes)
									:delete it if the corresponding log file not exists;
								elseif (is log file?) then(yes)
								:do sanity check for index, timeindex and transactionIndex files;
								:recoverSegment if any sanity checks fail;
								else(no)
									partition recoverSegment {
										:truncate and reload producer states between logStartOffset and segment's baseOffset;
										:find segments from lastSnapshotOffset and segment's baseOffset, load producers from log;
										:take a snapshot to avoid reloading all segments;
										partition recover {
											:reset index, timeindex and transactionIndex files;
											while (has more recordBatches?) 
												:validate batch;
												:calculate the maxTimestamp and offsetOfMaxTimestamp;

												:append index(batch's baseOffset, currentTotalValidBytes) to index file, 
												and append timeindex(maxTimestamp and offsetOfMaxTimestamp) to timeindex file
												if accumulated valid bytes are enough;

												:update latest leaderEpoch if batch's partitionLeaderEpoch > cache's lastEpoch;

												:update producer state
												1. append batch info to transaction queue if contains producer id
												2. complete transaction if batch is a controlBatch and transaction is openning
												3. append transaction index if the completed transaction is aborted
												2. update ProducerStateManager's mapEndOffset;
											endwhile
										}
										:take a snapshot after recover segment;
										:calculate truncated bytes(invalid bytes) after recover;
									}
								endif
							end while
						}

						partition completeSwapOperations {
							while (has more swapFiles?) 
								:new a swapLogSegment from swap files(log, index, timeindex, transactionIndex);
								:recover this swapLogSegment;
								:find oldSegments between swapLogSegment's baseOffset and nextOffset;
								:replace oldSegments by the swapSegment and delete them asynchronous;
							end while
						}

						if (segments isEmpty?) then(yes)
							:add a segment with 0 startOffset;
							:return 0 as nextOffset;
						elseif (logDir's name doesn't end with "-delete"?) then(yes)
							partition recoverLog {
								if (".kafka_cleanshutdown" file exists?) then(no)
									:find unflushedSegments beyond the recoveryPoint;
									while (has more unflushedSegments?)
										:recoverSegment;
										if (after recovery, truncted bytes > 0?) then(yes)
											:delete the rest unflushedSegments;
											:break loop;
										endif
									end while
								endif
								:get last segment's nextOffset as recoveryPoint;
							}
							:resize the last segment's index and timeindex file;
							:return nextOffset from recoverLog;
						else(no)
							:return 0 as nextOffset;
						endif
					}
					
					:get nextOffset after loadSegments and create nextLogOffsetMetadata; 
					:clean and flush latest leaderEpochCache with nextOffset;

					:calculate the new logStartOffset: 
					max(logStartOffset, first segment's baseOffset);

					:clean and flush earliest leaderEpochCache with logStartOffset;
					:load producer state from logEndOffset(todo);
				}

				if (logDir's name ends with "-delete"?) then(yes)
					:add to a queue for deleting in background;
				else
					:put log to LogManager's logs pool;
					if (there's a previous log for the same partition?) then(yes)
						#Red:Error for duplicate log directories;
					endif
				endif
			}
		fork again
			:load topicPartition-N log dir;
		end fork
	endwhile
}
stop
@enduml

PlantUML version 1.2018.08(Sun Jun 24 20:31:00 CST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_152-b16
Operating System: Windows 7
OS Version: 6.1
Default Encoding: Cp1252
Language: en
Country: US
--></g></svg>