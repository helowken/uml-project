@startuml
note over CheckAdditionalActionRequiredDefaultTask: get userCredentialList from request
group checkAdditionalActionRequired
	note over CheckAdditionalActionRequiredDefaultTask: get passwordType from extension in session 
	alt if user login not with OTP || OTP additional enabled
		group checkPasswordRelatedAdditionalActions
			alt if passwordType == "temppassword"
				note over CheckAdditionalActionRequiredDefaultTask: get tmppassword credential from userCredentialList
				alt if credential exists
					note over CheckAdditionalActionRequiredDefaultTask: add reset_password as additionalActionList
				end 
			else
				note over CheckAdditionalActionRequiredDefaultTask: get password credential from userCredentialList
				alt if credential exists
					alt if credential is force change password
						note over CheckAdditionalActionRequiredDefaultTask: add change_password as additionalActionList
					end
					alt if credential is password expired
						note over CheckAdditionalActionRequiredDefaultTask: add change_password as additionalActionList
					end
				end
			end
		end
		group checkSecurityQuestionRelatedAdditionalActions
			note over CheckAdditionalActionRequiredDefaultTask: get security question ids from userCredentialList
			alt if questionIds'size < min number
				note over CheckAdditionalActionRequiredDefaultTask: add provide_security_questions as additionalActionList
			end
		end
		alt if user is not anonymous
			CheckAdditionalActionRequiredDefaultTask -> OAuthIntegrationPointManager: ipAuthorizePostCheckAdditionalAction with additionalActionList
			OAuthIntegrationPointManager --> CheckAdditionalActionRequiredDefaultTask: ipResponseContext
		end
		alt if ipResponseContext is not empty && contains actions 
			note over CheckAdditionalActionRequiredDefaultTask: set additionalActionList as ipResponseContext's actions
		end
		alt if additionalActionList is not empty
			note over CheckAdditionalActionRequiredDefaultTask
				1. validate prompt from request
				2. build authorization response
				3. return response
			end note
		end
	else
		note over CheckAdditionalActionRequiredDefaultTask: return null
	end
end 
group suppress additional action
	group querySuppressionListByUserId
		note over CheckAdditionalActionRequiredDefaultTask
			1. query counters from DB by userId
			2. get suppression metadata
			3. filter counters within metadata as userSuppressedCounters
		end note
	end
	note over CheckAdditionalActionRequiredDefaultTask
		1. get triggered additionalActionList from response
		2. reset userSuppressedCounters which not within triggered additionalActionList
	end note
	alt if response is not null
		group filterSuppressionAction
			group checkClientSuppression
				alt if clientAllowedSuppressedActions is not empty
					loop action in triggered additionalActionList
						alt if action is in both clientAllowedSuppressedActions and clientSuppressionActions
							note over CheckAdditionalActionRequiredDefaultTask: filter out action
						end
					end
				else
					loop action in triggered additionalActionList
						alt if action is in clientSuppressionActions
							note over CheckAdditionalActionRequiredDefaultTask: filter out action
						end
					end
				end
			end
			group checkUserSuppression
				note over CheckAdditionalActionRequiredDefaultTask: get password credential from userCredentialList
				loop action in triggered additionalActionList
					alt if action == "change_password" && change password is required by force
						note over CheckAdditionalActionRequiredDefaultTask: skip
					end
					note over CheckAdditionalActionRequiredDefaultTask: get suppression metadata by action
					alt if metadata exists
						note over CheckAdditionalActionRequiredDefaultTask: get suppressedCounter by action
						alt if suppressedCount is not expired
							note over CheckAdditionalActionRequiredDefaultTask: skip
						end 
						alt if userRequestSuppression contains action
							alt if suppressedCounter exists
							else
							end
						end
					end
				end
			end
		end
		group increaseCounter
		end
		alt if filteredList is not empty
			note over CheckAdditionalActionRequiredDefaultTask: set response'actions as filteredActionList
		end
	end
end
@enduml
